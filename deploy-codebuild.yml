AWSTemplateFormatVersion: '2010-09-09'
Description: CodeBuild project for deploying OCR Vision Lab

Parameters:
  AdminUserEmail:
    Type: String
    Description: Admin user email for Cognito authentication
    AllowedPattern: '^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$'
    ConstraintDescription: Must be a valid email address

  InstanceType:
    Type: String
    Default: ml.g5.xlarge
    AllowedValues:
      - ml.g5.xlarge
      - ml.g5.2xlarge
      - ml.g4dn.xlarge
    Description: SageMaker instance type for OCR inference

  RepoUrl:
    Type: String
    Default: 'https://github.com/yunwoong7/aws-ocr-vision-lab.git'
    Description: Repository URL

  Version:
    Type: String
    Default: 'main'
    Description: Branch or tag to deploy

Resources:
  CodeBuildServiceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: codebuild.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/PowerUserAccess
      Policies:
        - PolicyName: CodeBuildServiceRolePolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: '*'
              - Effect: Allow
                Action:
                  - iam:CreateRole
                  - iam:DeleteRole
                  - iam:AttachRolePolicy
                  - iam:DetachRolePolicy
                  - iam:PutRolePolicy
                  - iam:DeleteRolePolicy
                  - iam:GetRole
                  - iam:GetRolePolicy
                  - iam:PassRole
                  - iam:TagRole
                  - iam:UntagRole
                  - iam:ListRolePolicies
                  - iam:ListAttachedRolePolicies
                  - iam:CreatePolicy
                  - iam:DeletePolicy
                  - iam:GetPolicy
                  - iam:GetPolicyVersion
                  - iam:ListPolicyVersions
                  - iam:CreateServiceLinkedRole
                Resource: '*'
              - Effect: Allow
                Action:
                  - ssm:GetParameter
                  - ssm:PutParameter
                  - ssm:DeleteParameter
                Resource: '*'
              - Effect: Allow
                Action:
                  - iam:UpdateAssumeRolePolicy
                  - iam:UpdateRole
                Resource:
                  - !Sub 'arn:aws:iam::${AWS::AccountId}:role/cdk-*'
              - Effect: Allow
                Action:
                  - sagemaker:*
                Resource: '*'
              - Effect: Allow
                Action:
                  - ecr:*
                Resource: '*'
              - Effect: Allow
                Action:
                  - cognito-idp:*
                Resource: '*'

  CodeBuildProject:
    Type: AWS::CodeBuild::Project
    Properties:
      Name: ocr-vision-lab-deploy
      ServiceRole: !GetAtt CodeBuildServiceRole.Arn
      Artifacts:
        Type: NO_ARTIFACTS
      Environment:
        Type: LINUX_CONTAINER
        ComputeType: BUILD_GENERAL1_LARGE
        Image: aws/codebuild/standard:7.0
        PrivilegedMode: true
        EnvironmentVariables:
          - Name: ADMIN_USER_EMAIL
            Value: !Ref AdminUserEmail
          - Name: INSTANCE_TYPE
            Value: !Ref InstanceType
          - Name: REPO_URL
            Value: !Ref RepoUrl
          - Name: VERSION
            Value: !Ref Version
          - Name: AWS_DEFAULT_REGION
            Value: !Ref AWS::Region
          - Name: AWS_ACCOUNT_ID
            Value: !Ref AWS::AccountId
          - Name: NODE_OPTIONS
            Value: '--max-old-space-size=8192'
      Source:
        Type: NO_SOURCE
        BuildSpec: |
          version: 0.2
          phases:
            pre_build:
              commands:
                - echo "Installing dependencies..."
                - npm install -g aws-cdk@latest pnpm
                - git clone $REPO_URL /tmp/aws-ocr-vision-lab
                - cd /tmp/aws-ocr-vision-lab
                - git checkout $VERSION
                - pnpm install

            build:
              commands:
                - cd /tmp/aws-ocr-vision-lab

                # Build all dependencies (required for CDK synthesis)
                - echo "Building dependencies..."
                - pnpm nx run @aws-ocr-vision-lab/common-constructs:compile
                - pnpm nx run @aws-ocr-vision-lab/frontend:bundle:production

                # Bootstrap CDK if needed (both main region and us-east-1 for WAF/CloudFront)
                - |
                  STACK_STATUS=$(aws cloudformation describe-stacks --stack-name CDKToolkit --query 'Stacks[0].StackStatus' --output text 2>/dev/null || echo "STACK_NOT_FOUND")
                  if [ "$STACK_STATUS" = "STACK_NOT_FOUND" ] || [ "$STACK_STATUS" = "ROLLBACK_COMPLETE" ]; then
                    echo "Bootstrapping CDK in $AWS_DEFAULT_REGION..."
                    npx cdk bootstrap aws://$AWS_ACCOUNT_ID/$AWS_DEFAULT_REGION --require-approval never
                  fi

                  # Bootstrap us-east-1 for WAF/CloudFront (required for cross-region resources)
                  US_EAST_STATUS=$(aws cloudformation describe-stacks --stack-name CDKToolkit --region us-east-1 --query 'Stacks[0].StackStatus' --output text 2>/dev/null || echo "STACK_NOT_FOUND")
                  if [ "$US_EAST_STATUS" = "STACK_NOT_FOUND" ] || [ "$US_EAST_STATUS" = "ROLLBACK_COMPLETE" ]; then
                    echo "Bootstrapping CDK in us-east-1 for WAF/CloudFront..."
                    npx cdk bootstrap aws://$AWS_ACCOUNT_ID/us-east-1 --require-approval never
                  fi

                # Deploy InfraStack (S3, ECR, CodeBuild for Docker)
                - echo "Deploying InfraStack..."
                - cd packages/infra
                - npx cdk deploy PaddleOCR-Infra --require-approval never

                # Build Docker image using CodeBuild
                - |
                  echo "Building Docker image..."
                  BUILD_PROJECT=$(aws cloudformation describe-stacks \
                    --stack-name PaddleOCR-Infra \
                    --query 'Stacks[0].Outputs[?OutputKey==`CodeBuildProjectName`].OutputValue' \
                    --output text 2>/dev/null || echo "")

                  if [ -n "$BUILD_PROJECT" ] && [ "$BUILD_PROJECT" != "None" ]; then
                    BUILD_ID=$(aws codebuild start-build --project-name $BUILD_PROJECT --query 'build.id' --output text)
                    echo "Started Docker build: $BUILD_ID"

                    # Wait for build to complete
                    while true; do
                      STATUS=$(aws codebuild batch-get-builds --ids $BUILD_ID --query 'builds[0].buildStatus' --output text)
                      echo "Build status: $STATUS"
                      if [ "$STATUS" = "SUCCEEDED" ]; then
                        echo "Docker image built successfully"
                        break
                      elif [ "$STATUS" = "FAILED" ] || [ "$STATUS" = "STOPPED" ]; then
                        echo "Docker build failed"
                        exit 1
                      fi
                      sleep 30
                    done
                  fi

                # Deploy ModelStack (upload inference.py as model.tar.gz)
                - echo "Deploying ModelStack..."
                - npx cdk deploy PaddleOCR-Model --require-approval never

                # Deploy ApplicationStack (Cognito, SageMaker, API, Frontend)
                - |
                  echo "Deploying ApplicationStack..."
                  npx cdk deploy PaddleOCR-Application \
                    --require-approval never \
                    --context adminUserEmail="$ADMIN_USER_EMAIL" \
                    --context instanceType="$INSTANCE_TYPE"

                # Get outputs
                - |
                  FRONTEND_DOMAIN=$(aws cloudformation describe-stacks \
                    --stack-name PaddleOCR-Application \
                    --query 'Stacks[0].Outputs[?contains(OutputKey,`DistributionDomainName`)].OutputValue' \
                    --output text 2>/dev/null || echo "")
                  FRONTEND_URL="https://${FRONTEND_DOMAIN}"

                  USER_POOL_ID=$(aws cloudformation describe-stacks \
                    --stack-name PaddleOCR-Application \
                    --query "Stacks[0].Outputs[?contains(OutputKey,'UserPoolId') && !contains(OutputKey,'Client')].OutputValue" \
                    --output text 2>/dev/null | awk '{print $1}')

                  # Get temporary password from Cognito
                  if [ -n "$USER_POOL_ID" ]; then
                    ADMIN_USERNAME=$(echo "$ADMIN_USER_EMAIL" | cut -d'@' -f1)

                    # Check if user exists
                    USER_EXISTS=$(aws cognito-idp admin-get-user \
                      --user-pool-id $USER_POOL_ID \
                      --username "$ADMIN_USERNAME" 2>/dev/null && echo "yes" || echo "no")

                    if [ "$USER_EXISTS" = "no" ]; then
                      aws cognito-idp admin-create-user \
                        --user-pool-id $USER_POOL_ID \
                        --username "$ADMIN_USERNAME" \
                        --user-attributes Name=email,Value="$ADMIN_USER_EMAIL" Name=email_verified,Value=true Name=given_name,Value=Admin Name=family_name,Value=User \
                        --temporary-password "TempPass123!" \
                        --message-action SUPPRESS
                      TEMP_PASSWORD="TempPass123!"
                      echo "Admin user created: $ADMIN_USERNAME"
                    else
                      echo "Admin user already exists: $ADMIN_USERNAME"
                      TEMP_PASSWORD="(existing user - use current password)"
                    fi
                  fi

                  echo "==========================================="
                  echo "Deployment Complete!"
                  echo "==========================================="
                  echo "FrontendURL = $FRONTEND_URL"
                  echo "AdminEmail = $ADMIN_USER_EMAIL"
                  echo "TemporaryPassword = $TEMP_PASSWORD"
                  echo "==========================================="

          post_build:
            commands:
              - echo "Deployment finished at $(date)"

      TimeoutInMinutes: 90

Outputs:
  ProjectName:
    Value: !Ref CodeBuildProject
    Description: CodeBuild project name

  ServiceRoleArn:
    Value: !GetAtt CodeBuildServiceRole.Arn
    Description: CodeBuild service role ARN
